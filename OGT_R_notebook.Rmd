---
title: "Data Source Jam"
subtitle: "Project: Siemens EM MS PMBP - Utilization Forecast"
date: 2018-05-04  
output:
  html_document:
    code_folding: hide
  pdf_document: default
  word_document: default
  df_print: paged
---

#Data Exploration Loop 1
Analyzed file(s): OGT offer data

Data Exploration Topics

* Summary statistics (incl. mean, median, variations, ...)
* Five numbers summary by boxplots (numerical data)
* Distribution by bar charts and histograms
* Categories reduction
* Derived variables
* Missing values and outliers
* Subgroups, patterns and trends
* Covariations (relationships between pairs of attributes)
    - distribution of a continuous variable broken down by a categorical variable
    - between categorical variables
    - between two continuous variables
* Correlations (numerical variables)

```{r, echo = FALSE}
# ====================== Libraries ================
library(readxl)
library(tidyverse)
library(hexbin)

# ====================== Parameters ==============
#setwd("C:/Users/A413401/4_GER_People/Learning/R/Data_explore")  
rel_fpath  <- "./data/OGT/"
rel_fpath_output <- "./data/"
outputfile <- "./output/data_exploration.pdf"  # writes plots and clean data frame to outputfile
outputcsv  <- "./output/clean_4_modelling_with_R.csv"
Read_Fresh_from_File <- T # Set to TRUE for first run to fill var rawframe
                          # clean dat frame, set to FALSE for initial data understanding
options(scipen=999)       # suppress exponential form of print output format
printpdf <- FALSE         # if printout in PDF desired
shortnames <- TRUE        # if T change to short variable names is desired
scatterplot <- FALSE      # it T do scatterplot
basic_tranform <- FALSE    # do basic feature transformations

# ====================== Sources ===============
source(file = "Functions_data_exploration.R")
```
#2. D a t a   U n d e r s t a n d i n g
  
##2.1 Collect Initial Data

Routines:  
Read from data sources from "rel_fpath"!  
Read description and configuration file from "rel_fpath"!  
Save data as RDS file format 

```{r, echo = FALSE}
# ====================== R e a d   d a t a ==============
if (Read_Fresh_from_File)  {
  print("reading file.... please wait")
  
  rawframe <- read_xlsx (path = paste0(rel_fpath, 'OGT Offer alle Positionen Fertigung Turkey.xlsx'), guess_max=35544)
  warnings()
  
  datadesc <- read_xlsx (path = paste0(rel_fpath, 'DQA_dd_OGT_Offer.xlsx'), 
                         sheet = "datadesc", col_types = c(
                           "text",      # Field Name
                           "text",      # Field Description
                           "text",      # Marker for Clean Data Frame
                           "text",      # Scale of Mesurement
                           "text",      # Binary Default 0
                           "text",      # Comment on outlier checking
                           "text",      # comment on data exploration result
                           "text",      # Create dummy var if "x" 
                           "text",      # Reduce which Dummy
                           "numeric"))  # % of na values
  warnings() 
}
saveRDS(rawframe, file = paste(rel_fpath_output , "OGT_Offer.rData"))
```

```{r, echo = FALSE}
rel_fpath  <- "./data/" # wÃ¤re oben anzupassen
# ====================== R e a d   d a t a ============== alternative
if (Read_Fresh_from_File)  {
  print("reading file.... ")
  filename='OGT Offer alle Positionen Fertigung Turkey' 
  endung ='.xlsx'
  rawframe <- read_xlsx (path = paste0(rel_fpath, filename, endung ), guess_max=35544)
  warnings()
  
  if (file.exists(path = paste0(rel_fpath, filename, '_data_control', endung)))
    data_control_file <-  paste0(rel_fpath, filename, '_data_control', endung) else
      data_control_file <- paste0(rel_fpath, 'data_control_template.xlsx')

    datadesc <- read_xlsx (data_control_file, 
                         sheet = "datadesc", col_types = c(
                           "text",      # Field Name
                           "text",      # Field Description
                           "text",      # Marker for Clean Data Frame
                           "text",      # Scale of Mesurement
                           "text",      # Binary Default 0
                           "text",      # Comment on outlier checking
                           "text",      # comment on data exploration result
                           "text",      # Create dummy var if "x" 
                           "text",      # Reduce which Dummy
                           "numeric"))  # % of na values
  warnings() 
  # write control file if not present
  if (!file.exists(path = paste0(rel_fpath, filename, '_data_control', endung)))
  {
    datadesc[1:length(names(rawframe)), 1] <-  names(rawframe)
    library(writexl)
    writexl::write_xlsx(datadesc, path = paste0(rel_fpath, filename, '_data_control', endung))
    }

}
saveRDS(rawframe, file = paste(rel_fpath_output , "OGT_Offer.rData"))
print("...Data saved in RData file")
```



##2.2 Describe Data   

##2.3 Explore Data and Visualization

Routines:  
Create sub dataframe of numeric varialbes  
Create a sub dataframe of non numeric varialbes  
Do basic data transformation  
```{r, echo = FALSE}
#create a sub dataframe of numeric varialbes
df_num <- as.data.frame (rawframe [ , sapply(rawframe,is.numeric)])

#create a sub dataframe of non numeric varialbes
df_not_num <- as.data.frame (rawframe [ , !sapply(rawframe,is.numeric)])

#basic transformations
if (basic_tranform) {
  df_num$`Total Customer Price (EUR)` <- log(df_num$`Total Customer Price (EUR)`)
  df_num$`L-/T-Price (EUR)` <- log (df_num$`L-/T-Price (EUR)`)
  df_num$`Order Cost (EUR)` <- log (df_num$`Order Cost (EUR)`)
  df_num$`Customer Target Price` <- log(df_num$`Order Cost (EUR)`) ### micmic  c+p error?
  df_num$`L-Price` <- log(df_num$`Order Cost (EUR)`) ### micmic 
}
```
```{r}
print (paste("Dimension of dataframe of numeric variables (columns)", dim(df_num)[2]))
print (paste("Dimension of dataframe of not-numeric variables (columns)", dim(df_not_num)[2]))
```

### 2.3.1 Boxplots and Histograms of all numerical variables

```{r, echo = FALSE}

if (printpdf) pdf(outputfile)
if (scatterplot) plot (df_num) # scatter plot
plot_num (df_num, datadesc)
if (printpdf) dev.off()    # reset device to screen plot 
```

Explore variable "Item"

Peaks at 10x iterm

```{r}
# Limitiation of counts on y axis as well as outliers on x axis
ggplot(data = df_num) +
  geom_histogram(mapping = aes(x = df_num$Item), binwidth = 1, na.rm = TRUE) +
  coord_cartesian(xlim = c(0, 400), ylim = c(0, 100)) +
  labs(x = names(df_num$item))

# use group by and summarize allways together
c_items <- df_num %>%
  group_by(Item) %>%
  summarise(count = n()) %>%
  print()
  
```

```{r}
ggplot(data = df_num) +
        geom_boxplot(mapping = aes(x = df_not_num$Status, y = df_num$`Probability of Order`) , na.rm = TRUE) +
        labs(x = names(df_num$`Probability of Order`), y = "")
```

### 2.3.2 Exploration of all non numerical variables

```{r, echo = FALSE}

summary_non_num (df_not_num, datadesc)
```

## 2.4 Verify data quality

### 2.4.1 check missing values

```{r}

for(i in 1:nrow(datadesc)){  
  print(names(rawframe[i]))
  print(paste("# na:", colSums(is.na(rawframe[i])), "  in %", colSums(is.na(rawframe[i]))/nrow(rawframe)*100))
  datadesc$`% of na values`[i] <- colSums(is.na(rawframe[i]))/nrow(rawframe)*100
}    
#write.csv2(datadesc$`% of na values`, file = "na_%.csv")
```


### 2.4.2 check collinearity


```{r}

# produce correlation matrix
check_collinearity (df_num)
```

